{"version":3,"sources":["nano.js"],"names":["Emitter","obj","mixin","key","prototype","on","addEventListener","event","fn","_callbacks","push","once","self","off","apply","arguments","removeListener","removeAllListeners","removeEventListener","length","callbacks","cb","i","splice","emit","args","slice","call","len","listeners","hasListeners","JS_WS_CLIENT_TYPE","JS_WS_CLIENT_VERSION","Protocol","window","decodeIO_encoder","decodeIO_decoder","Package","Message","EventEmitter","rsa","RES_OK","RES_FAIL","RES_OLD_CLIENT","Object","create","o","F","root","nano","socket","reqId","handlers","routeMap","dict","abbrs","heartbeatInterval","heartbeatTimeout","nextHeartbeatTimeout","gapThreshold","heartbeatId","heartbeatTimeoutId","handshakeCallback","decode","encode","reconnect","reconncetTimer","reconnectUrl","reconnectAttempts","reconnectionDelay","DEFAULT_MAX_RECONNECT_ATTEMPTS","useCrypto","handshakeBuffer","type","version","initCallback","init","params","host","port","path","defaultEncode","defaultDecode","url","user","encrypt","generate","data","rsa_n","n","toString","rsa_e","e","sys","connect","msg","id","route","body","deCompose","TYPE_REQUEST","TYPE_NOTIFY","lookup","Builder","build","encodeNB","strencode","JSON","stringify","compressRoute","console","log","maxReconnectAttempts","onopen","reset","TYPE_HANDSHAKE","send","onmessage","processPackage","Date","now","onerror","error","onclose","setTimeout","WebSocket","binaryType","disconnect","close","clearTimeout","request","sendMessage","notify","sig","signString","parse","packet","TYPE_DATA","buffer","handler","heartbeat","TYPE_HEARTBEAT","heartbeatTimeoutCb","gap","handshake","strdecode","code","handshakeInit","TYPE_HANDSHAKE_ACK","onData","processMessage","onKick","TYPE_KICK","msgs","Array","isArray","processMessageBatch","l","initData"],"mappings":";;;;;;AAAA,CAAC,YAAW;AACR,WAASA,OAAT,CAAiBC,GAAjB,EAAsB;AACtB,QAAIA,GAAJ,EAAS,OAAOC,MAAMD,GAAN,CAAP;AACV;AACC;;;;;;;;AAQF,WAASC,KAAT,CAAeD,GAAf,EAAoB;AAClB,SAAK,IAAIE,GAAT,IAAgBH,QAAQI,SAAxB,EAAmC;AACjCH,UAAIE,GAAJ,IAAWH,QAAQI,SAAR,CAAkBD,GAAlB,CAAX;AACD;AACD,WAAOF,GAAP;AACD;;AAED;;;;;;;;;AASAD,UAAQI,SAAR,CAAkBC,EAAlB,GACAL,QAAQI,SAAR,CAAkBE,gBAAlB,GAAqC,UAASC,KAAT,EAAgBC,EAAhB,EAAmB;AACtD,SAAKC,UAAL,GAAkB,KAAKA,UAAL,IAAmB,EAArC;AACA,KAAC,KAAKA,UAAL,CAAgBF,KAAhB,IAAyB,KAAKE,UAAL,CAAgBF,KAAhB,KAA0B,EAApD,EACGG,IADH,CACQF,EADR;AAEA,WAAO,IAAP;AACD,GAND;;AAQA;;;;;;;;;;AAUAR,UAAQI,SAAR,CAAkBO,IAAlB,GAAyB,UAASJ,KAAT,EAAgBC,EAAhB,EAAmB;AAC1C,QAAII,OAAO,IAAX;AACA,SAAKH,UAAL,GAAkB,KAAKA,UAAL,IAAmB,EAArC;;AAEA,aAASJ,EAAT,GAAc;AACZO,WAAKC,GAAL,CAASN,KAAT,EAAgBF,EAAhB;AACAG,SAAGM,KAAH,CAAS,IAAT,EAAeC,SAAf;AACD;;AAEDV,OAAGG,EAAH,GAAQA,EAAR;AACA,SAAKH,EAAL,CAAQE,KAAR,EAAeF,EAAf;AACA,WAAO,IAAP;AACD,GAZD;;AAcA;;;;;;;;;;AAUAL,UAAQI,SAAR,CAAkBS,GAAlB,GACAb,QAAQI,SAAR,CAAkBY,cAAlB,GACAhB,QAAQI,SAAR,CAAkBa,kBAAlB,GACAjB,QAAQI,SAAR,CAAkBc,mBAAlB,GAAwC,UAASX,KAAT,EAAgBC,EAAhB,EAAmB;AACzD,SAAKC,UAAL,GAAkB,KAAKA,UAAL,IAAmB,EAArC;;AAEA;AACA,QAAI,KAAKM,UAAUI,MAAnB,EAA2B;AACzB,WAAKV,UAAL,GAAkB,EAAlB;AACA,aAAO,IAAP;AACD;;AAED;AACA,QAAIW,YAAY,KAAKX,UAAL,CAAgBF,KAAhB,CAAhB;AACA,QAAI,CAACa,SAAL,EAAgB,OAAO,IAAP;;AAEhB;AACA,QAAI,KAAKL,UAAUI,MAAnB,EAA2B;AACzB,aAAO,KAAKV,UAAL,CAAgBF,KAAhB,CAAP;AACA,aAAO,IAAP;AACD;;AAED;AACA,QAAIc,EAAJ;AACA,SAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIF,UAAUD,MAA9B,EAAsCG,GAAtC,EAA2C;AACzCD,WAAKD,UAAUE,CAAV,CAAL;AACA,UAAID,OAAOb,EAAP,IAAaa,GAAGb,EAAH,KAAUA,EAA3B,EAA+B;AAC7BY,kBAAUG,MAAV,CAAiBD,CAAjB,EAAoB,CAApB;AACA;AACD;AACF;AACD,WAAO,IAAP;AACD,GAhCD;;AAkCA;;;;;;;;AAQAtB,UAAQI,SAAR,CAAkBoB,IAAlB,GAAyB,UAASjB,KAAT,EAAe;AACtC,SAAKE,UAAL,GAAkB,KAAKA,UAAL,IAAmB,EAArC;AACA,QAAIgB,OAAO,GAAGC,KAAH,CAASC,IAAT,CAAcZ,SAAd,EAAyB,CAAzB,CAAX;AAAA,QACIK,YAAY,KAAKX,UAAL,CAAgBF,KAAhB,CADhB;;AAGA,QAAIa,SAAJ,EAAe;AACbA,kBAAYA,UAAUM,KAAV,CAAgB,CAAhB,CAAZ;AACA,WAAK,IAAIJ,IAAI,CAAR,EAAWM,MAAMR,UAAUD,MAAhC,EAAwCG,IAAIM,GAA5C,EAAiD,EAAEN,CAAnD,EAAsD;AACpDF,kBAAUE,CAAV,EAAaR,KAAb,CAAmB,IAAnB,EAAyBW,IAAzB;AACD;AACF;;AAED,WAAO,IAAP;AACD,GAbD;;AAeA;;;;;;;;AAQAzB,UAAQI,SAAR,CAAkByB,SAAlB,GAA8B,UAAStB,KAAT,EAAe;AAC3C,SAAKE,UAAL,GAAkB,KAAKA,UAAL,IAAmB,EAArC;AACA,WAAO,KAAKA,UAAL,CAAgBF,KAAhB,KAA0B,EAAjC;AACD,GAHD;;AAKA;;;;;;;;AAQAP,UAAQI,SAAR,CAAkB0B,YAAlB,GAAiC,UAASvB,KAAT,EAAe;AAC9C,WAAO,CAAC,CAAE,KAAKsB,SAAL,CAAetB,KAAf,EAAsBY,MAAhC;AACD,GAFD;AAGA,MAAIY,oBAAoB,cAAxB;AACA,MAAIC,uBAAuB,OAA3B;;AAEA,MAAIC,WAAWC,OAAOD,QAAtB;AACA,MAAIE,mBAAmB,IAAvB;AACA,MAAIC,mBAAmB,IAAvB;AACA,MAAIC,UAAUJ,SAASI,OAAvB;AACA,MAAIC,UAAUL,SAASK,OAAvB;AACA,MAAIC,eAAevC,OAAnB;AACA,MAAIwC,MAAMN,OAAOM,GAAjB;;AAEA,MAAIC,SAAS,GAAb;AACA,MAAIC,WAAW,GAAf;AACA,MAAIC,iBAAiB,GAArB;;AAEA,MAAI,OAAOC,OAAOC,MAAd,KAAyB,UAA7B,EAAyC;AACvCD,WAAOC,MAAP,GAAgB,UAAUC,CAAV,EAAa;AAC3B,eAASC,CAAT,GAAa,CAAE;AACfA,QAAE3C,SAAF,GAAc0C,CAAd;AACA,aAAO,IAAIC,CAAJ,EAAP;AACD,KAJD;AAKD;;AAED,MAAIC,OAAOd,MAAX;AACA,MAAIe,OAAOL,OAAOC,MAAP,CAAcN,aAAanC,SAA3B,CAAX,CA/KU,CA+KwC;AAClD4C,OAAKC,IAAL,GAAYA,IAAZ;AACA,MAAIC,SAAS,IAAb;AACA,MAAIC,QAAQ,CAAZ;AACA,MAAI/B,YAAY,EAAhB;AACA,MAAIgC,WAAW,EAAf;AACA;AACA,MAAIC,WAAW,EAAf;AACA,MAAIC,OAAO,EAAX,CAvLU,CAuLQ;AAClB,MAAIC,QAAQ,EAAZ,CAxLU,CAwLQ;;AAElB,MAAIC,oBAAoB,CAAxB;AACA,MAAIC,mBAAmB,CAAvB;AACA,MAAIC,uBAAuB,CAA3B;AACA,MAAIC,eAAe,GAAnB,CA7LU,CA6LgB;AAC1B,MAAIC,cAAc,IAAlB;AACA,MAAIC,qBAAqB,IAAzB;AACA,MAAIC,oBAAoB,IAAxB;;AAEA,MAAIC,SAAS,IAAb;AACA,MAAIC,SAAS,IAAb;;AAEA,MAAIC,YAAY,KAAhB;AACA,MAAIC,iBAAiB,IAArB;AACA,MAAIC,eAAe,IAAnB;AACA,MAAIC,oBAAoB,CAAxB;AACA,MAAIC,oBAAoB,IAAxB;AACA,MAAIC,iCAAiC,EAArC;;AAEA,MAAIC,SAAJ;;AAEA,MAAIC,kBAAkB;AACpB,WAAO;AACLC,YAAM1C,iBADD;AAEL2C,eAAS1C,oBAFJ;AAGLQ,WAAK;AAHA,KADa;AAMpB,YAAQ;AANY,GAAtB;;AAUA,MAAImC,eAAe,IAAnB;;AAEA1B,OAAK2B,IAAL,GAAY,UAASC,MAAT,EAAiBxD,EAAjB,EAAqB;AAC/BsD,mBAAetD,EAAf;AACA,QAAIyD,OAAOD,OAAOC,IAAlB;AACA,QAAIC,OAAOF,OAAOE,IAAlB;AACA,QAAIC,OAAOH,OAAOG,IAAlB;;AAEAhB,aAASa,OAAOb,MAAP,IAAiBiB,aAA1B;AACAlB,aAASc,OAAOd,MAAP,IAAiBmB,aAA1B;;AAEA,QAAIC,MAAM,UAAUL,IAApB;AACA,QAAGC,IAAH,EAAS;AACPI,aAAQ,MAAMJ,IAAd;AACD;;AAED,QAAGC,IAAH,EAAS;AACPG,aAAOH,IAAP;AACD;;AAEDR,oBAAgBY,IAAhB,GAAuBP,OAAOO,IAA9B;AACA,QAAGP,OAAOQ,OAAV,EAAmB;AACjBd,kBAAY,IAAZ;AACA/B,UAAI8C,QAAJ,CAAa,IAAb,EAAmB,OAAnB;AACA,UAAIC,OAAO;AACTC,eAAOhD,IAAIiD,CAAJ,CAAMC,QAAN,CAAe,EAAf,CADE;AAETC,eAAOnD,IAAIoD;AAFF,OAAX;AAIApB,sBAAgBqB,GAAhB,CAAoBrD,GAApB,GAA0B+C,IAA1B;AACD;AACDzB,wBAAoBe,OAAOf,iBAA3B;AACAgC,YAAQjB,MAAR,EAAgBM,GAAhB,EAAqB9D,EAArB;AACD,GA9BD;;AAgCA,MAAI6D,gBAAgBjC,KAAKc,MAAL,GAAc,UAASwB,IAAT,EAAe;AAC/C,QAAIQ,MAAMzD,QAAQyB,MAAR,CAAewB,IAAf,CAAV;;AAEA,QAAGQ,IAAIC,EAAJ,GAAS,CAAZ,EAAc;AACZD,UAAIE,KAAJ,GAAY5C,SAAS0C,IAAIC,EAAb,CAAZ;AACA,aAAO3C,SAAS0C,IAAIC,EAAb,CAAP;AACA,UAAG,CAACD,IAAIE,KAAR,EAAc;AACZ;AACD;AACF;;AAEDF,QAAIG,IAAJ,GAAWC,UAAUJ,GAAV,CAAX;AACA,WAAOA,GAAP;AACD,GAbD;;AAeA,MAAId,gBAAgBhC,KAAKe,MAAL,GAAc,UAASb,KAAT,EAAgB8C,KAAhB,EAAuBF,GAAvB,EAA4B;AAC5D,QAAItB,OAAOtB,QAAQb,QAAQ8D,YAAhB,GAA+B9D,QAAQ+D,WAAlD;;AAEA,QAAGlE,oBAAoBA,iBAAiBmE,MAAjB,CAAwBL,KAAxB,CAAvB,EAAuD;AACrD,UAAIM,UAAUpE,iBAAiBqE,KAAjB,CAAuBP,KAAvB,CAAd;AACAF,YAAM,IAAIQ,OAAJ,CAAYR,GAAZ,EAAiBU,QAAjB,EAAN;AACD,KAHD,MAGO;AACLV,YAAM9D,SAASyE,SAAT,CAAmBC,KAAKC,SAAL,CAAeb,GAAf,CAAnB,CAAN;AACD;;AAED,QAAIc,gBAAgB,CAApB;AACA,QAAGvD,QAAQA,KAAK2C,KAAL,CAAX,EAAwB;AACtBA,cAAQ3C,KAAK2C,KAAL,CAAR;AACAY,sBAAgB,CAAhB;AACD;;AAED,WAAOvE,QAAQ0B,MAAR,CAAeb,KAAf,EAAsBsB,IAAtB,EAA4BoC,aAA5B,EAA2CZ,KAA3C,EAAkDF,GAAlD,CAAP;AACD,GAjBD;;AAmBA,MAAID,UAAU,SAAVA,OAAU,CAASjB,MAAT,EAAiBM,GAAjB,EAAsB9D,EAAtB,EAA0B;AACtCyF,YAAQC,GAAR,CAAY,gBAAgB5B,GAA5B;;AAEA,QAAIN,SAASA,UAAU,EAAvB;AACA,QAAImC,uBAAuBnC,OAAOmC,oBAAP,IAA+B1C,8BAA1D;AACAH,mBAAegB,GAAf;;AAEA,QAAI8B,SAAS,SAATA,MAAS,CAAS1G,KAAT,EAAgB;AAC3B,UAAG,CAAC,CAAC0D,SAAL,EAAgB;AACdhB,aAAKzB,IAAL,CAAU,WAAV;AACD;AACD0F;AACA,UAAIjH,MAAMoC,QAAQ2B,MAAR,CAAe3B,QAAQ8E,cAAvB,EAAuClF,SAASyE,SAAT,CAAmBC,KAAKC,SAAL,CAAepC,eAAf,CAAnB,CAAvC,CAAV;AACA4C,WAAKnH,GAAL;AACD,KAPD;AAQA,QAAIoH,YAAY,SAAZA,SAAY,CAAS9G,KAAT,EAAgB;AAC9B+G,qBAAejF,QAAQ0B,MAAR,CAAexD,MAAMgF,IAArB,CAAf,EAA2ClE,EAA3C;AACA;AACA,UAAGoC,gBAAH,EAAqB;AACnBC,+BAAuB6D,KAAKC,GAAL,KAAa/D,gBAApC;AACD;AACF,KAND;AAOA,QAAIgE,UAAU,SAAVA,OAAU,CAASlH,KAAT,EAAgB;AAC5B0C,WAAKzB,IAAL,CAAU,UAAV,EAAsBjB,KAAtB;AACAuG,cAAQY,KAAR,CAAc,gBAAd,EAAgCnH,KAAhC;AACD,KAHD;AAIA,QAAIoH,UAAU,SAAVA,OAAU,CAASpH,KAAT,EAAgB;AAC5B0C,WAAKzB,IAAL,CAAU,OAAV,EAAkBjB,KAAlB;AACA0C,WAAKzB,IAAL,CAAU,YAAV,EAAwBjB,KAAxB;AACAuG,cAAQC,GAAR,CAAY,gBAAZ,EAA8BxG,KAA9B;AACA,UAAG,CAAC,CAACsE,OAAOZ,SAAT,IAAsBG,oBAAoB4C,oBAA7C,EAAmE;AACjE/C,oBAAY,IAAZ;AACAG;AACAF,yBAAiB0D,WAAW,YAAW;AACrC9B,kBAAQjB,MAAR,EAAgBV,YAAhB,EAA8B9C,EAA9B;AACD,SAFgB,EAEdgD,iBAFc,CAAjB;AAGAA,6BAAqB,CAArB;AACD;AACF,KAZD;AAaAnB,aAAS,IAAI2E,SAAJ,CAAc1C,GAAd,CAAT;AACAjC,WAAO4E,UAAP,GAAoB,aAApB;AACA5E,WAAO+D,MAAP,GAAgBA,MAAhB;AACA/D,WAAOmE,SAAP,GAAmBA,SAAnB;AACAnE,WAAOuE,OAAP,GAAiBA,OAAjB;AACAvE,WAAOyE,OAAP,GAAiBA,OAAjB;AACD,GA7CD;;AA+CA1E,OAAK8E,UAAL,GAAkB,YAAW;AAC3B,QAAG7E,MAAH,EAAW;AACT,UAAGA,OAAO6E,UAAV,EAAsB7E,OAAO6E,UAAP;AACtB,UAAG7E,OAAO8E,KAAV,EAAiB9E,OAAO8E,KAAP;AACjBlB,cAAQC,GAAR,CAAY,YAAZ;AACA7D,eAAS,IAAT;AACD;;AAED,QAAGU,WAAH,EAAgB;AACdqE,mBAAarE,WAAb;AACAA,oBAAc,IAAd;AACD;AACD,QAAGC,kBAAH,EAAuB;AACrBoE,mBAAapE,kBAAb;AACAA,2BAAqB,IAArB;AACD;AACF,GAhBD;;AAkBA,MAAIqD,QAAQ,SAARA,KAAQ,GAAW;AACrBjD,gBAAY,KAAZ;AACAI,wBAAoB,OAAO,CAA3B;AACAD,wBAAoB,CAApB;AACA6D,iBAAa/D,cAAb;AACD,GALD;;AAOAjB,OAAKiF,OAAL,GAAe,UAASjC,KAAT,EAAgBF,GAAhB,EAAqB1E,EAArB,EAAyB;AACtC,QAAGN,UAAUI,MAAV,KAAqB,CAArB,IAA0B,OAAO4E,GAAP,KAAe,UAA5C,EAAwD;AACtD1E,WAAK0E,GAAL;AACAA,YAAM,EAAN;AACD,KAHD,MAGO;AACLA,YAAMA,OAAO,EAAb;AACD;AACDE,YAAQA,SAASF,IAAIE,KAArB;AACA,QAAG,CAACA,KAAJ,EAAW;AACT;AACD;;AAED9C;AACAgF,gBAAYhF,KAAZ,EAAmB8C,KAAnB,EAA0BF,GAA1B;;AAEA3E,cAAU+B,KAAV,IAAmB9B,EAAnB;AACAgC,aAASF,KAAT,IAAkB8C,KAAlB;AACD,GAjBD;;AAmBAhD,OAAKmF,MAAL,GAAc,UAASnC,KAAT,EAAgBF,GAAhB,EAAqB;AACjCA,UAAMA,OAAO,EAAb;AACAoC,gBAAY,CAAZ,EAAelC,KAAf,EAAsBF,GAAtB;AACD,GAHD;;AAKA,MAAIoC,cAAc,SAAdA,WAAc,CAAShF,KAAT,EAAgB8C,KAAhB,EAAuBF,GAAvB,EAA4B;AAC5C,QAAGxB,SAAH,EAAc;AACZwB,YAAMY,KAAKC,SAAL,CAAeb,GAAf,CAAN;AACA,UAAIsC,MAAM7F,IAAI8F,UAAJ,CAAevC,GAAf,EAAoB,QAApB,CAAV;AACAA,YAAMY,KAAK4B,KAAL,CAAWxC,GAAX,CAAN;AACAA,UAAI,YAAJ,IAAoBsC,GAApB;AACD;;AAED,QAAGrE,MAAH,EAAW;AACT+B,YAAM/B,OAAOb,KAAP,EAAc8C,KAAd,EAAqBF,GAArB,CAAN;AACD;;AAED,QAAIyC,SAASnG,QAAQ2B,MAAR,CAAe3B,QAAQoG,SAAvB,EAAkC1C,GAAlC,CAAb;AACAqB,SAAKoB,MAAL;AACD,GAdD;;AAgBA,MAAIpB,OAAO,SAAPA,IAAO,CAASoB,MAAT,EAAiB;AAC1BtF,WAAOkE,IAAP,CAAYoB,OAAOE,MAAnB;AACD,GAFD;;AAIA,MAAIC,UAAU,EAAd;;AAEA,MAAIC,YAAY,SAAZA,SAAY,CAASrD,IAAT,EAAe;AAC7B,QAAG,CAAC/B,iBAAJ,EAAuB;AACrB;AACA;AACD;;AAED,QAAIvD,MAAMoC,QAAQ2B,MAAR,CAAe3B,QAAQwG,cAAvB,CAAV;AACA,QAAGhF,kBAAH,EAAuB;AACrBoE,mBAAapE,kBAAb;AACAA,2BAAqB,IAArB;AACD;;AAED,QAAGD,WAAH,EAAgB;AACd;AACA;AACD;AACDA,kBAAcgE,WAAW,YAAW;AAClChE,oBAAc,IAAd;AACAwD,WAAKnH,GAAL;;AAEAyD,6BAAuB6D,KAAKC,GAAL,KAAa/D,gBAApC;AACAI,2BAAqB+D,WAAWkB,kBAAX,EAA+BrF,gBAA/B,CAArB;AACD,KANa,EAMXD,iBANW,CAAd;AAOD,GAvBD;;AAyBA,MAAIsF,qBAAqB,SAArBA,kBAAqB,GAAW;AAClC,QAAIC,MAAMrF,uBAAuB6D,KAAKC,GAAL,EAAjC;AACA,QAAGuB,MAAMpF,YAAT,EAAuB;AACrBE,2BAAqB+D,WAAWkB,kBAAX,EAA+BC,GAA/B,CAArB;AACD,KAFD,MAEO;AACLjC,cAAQY,KAAR,CAAc,0BAAd;AACAzE,WAAKzB,IAAL,CAAU,mBAAV;AACAyB,WAAK8E,UAAL;AACD;AACF,GATD;;AAWA,MAAIiB,YAAY,SAAZA,SAAY,CAASzD,IAAT,EAAe;AAC7BA,WAAOoB,KAAK4B,KAAL,CAAWtG,SAASgH,SAAT,CAAmB1D,IAAnB,CAAX,CAAP;AACA,QAAGA,KAAK2D,IAAL,KAAcvG,cAAjB,EAAiC;AAC/BM,WAAKzB,IAAL,CAAU,OAAV,EAAmB,6BAAnB;AACA;AACD;;AAED,QAAG+D,KAAK2D,IAAL,KAAczG,MAAjB,EAAyB;AACvBQ,WAAKzB,IAAL,CAAU,OAAV,EAAmB,gBAAnB;AACA;AACD;;AAED2H,kBAAc5D,IAAd;;AAEA,QAAItF,MAAMoC,QAAQ2B,MAAR,CAAe3B,QAAQ+G,kBAAvB,CAAV;AACAhC,SAAKnH,GAAL;AACA,QAAG0E,YAAH,EAAiB;AACfA,mBAAazB,MAAb;AACD;AACF,GAnBD;;AAqBA,MAAImG,SAAS,SAATA,MAAS,CAAS9D,IAAT,EAAe;AAC1B,QAAIQ,MAAMR,IAAV;AACA,QAAGxB,MAAH,EAAW;AACTgC,YAAMhC,OAAOgC,GAAP,CAAN;AACD;AACDuD,mBAAerG,IAAf,EAAqB8C,GAArB;AACD,GAND;;AAQA,MAAIwD,SAAS,SAATA,MAAS,CAAShE,IAAT,EAAe;AAC1BA,WAAOoB,KAAK4B,KAAL,CAAWtG,SAASgH,SAAT,CAAmB1D,IAAnB,CAAX,CAAP;AACAtC,SAAKzB,IAAL,CAAU,QAAV,EAAoB+D,IAApB;AACD,GAHD;;AAKAnC,WAASf,QAAQ8E,cAAjB,IAAmC6B,SAAnC;AACA5F,WAASf,QAAQwG,cAAjB,IAAmCD,SAAnC;AACAxF,WAASf,QAAQoG,SAAjB,IAA8BY,MAA9B;AACAjG,WAASf,QAAQmH,SAAjB,IAA8BD,MAA9B;;AAEA,MAAIjC,iBAAiB,SAAjBA,cAAiB,CAASmC,IAAT,EAAe;AAClC,QAAGC,MAAMC,OAAN,CAAcF,IAAd,CAAH,EAAwB;AACtB,WAAI,IAAInI,IAAE,CAAV,EAAaA,IAAEmI,KAAKtI,MAApB,EAA4BG,GAA5B,EAAiC;AAC/B,YAAIyE,MAAM0D,KAAKnI,CAAL,CAAV;AACA8B,iBAAS2C,IAAItB,IAAb,EAAmBsB,IAAIG,IAAvB;AACD;AACF,KALD,MAKO;AACL9C,eAASqG,KAAKhF,IAAd,EAAoBgF,KAAKvD,IAAzB;AACD;AACF,GATD;;AAWA,MAAIoD,iBAAiB,SAAjBA,cAAiB,CAASrG,IAAT,EAAe8C,GAAf,EAAoB;AACvC,QAAG,CAACA,IAAIC,EAAR,EAAY;AACV;AACA/C,WAAKzB,IAAL,CAAUuE,IAAIE,KAAd,EAAqBF,IAAIG,IAAzB;AACA;AACD;;AAED;AACA,QAAI7E,KAAKD,UAAU2E,IAAIC,EAAd,CAAT;;AAEA,WAAO5E,UAAU2E,IAAIC,EAAd,CAAP;AACA,QAAG,OAAO3E,EAAP,KAAc,UAAjB,EAA6B;AAC3B;AACD;;AAEDA,OAAG0E,IAAIG,IAAP;AAED,GAjBD;;AAmBA,MAAI0D,sBAAsB,SAAtBA,mBAAsB,CAAS3G,IAAT,EAAewG,IAAf,EAAqB;AAC7C,SAAI,IAAInI,IAAE,CAAN,EAASuI,IAAEJ,KAAKtI,MAApB,EAA4BG,IAAEuI,CAA9B,EAAiCvI,GAAjC,EAAsC;AACpCgI,qBAAerG,IAAf,EAAqBwG,KAAKnI,CAAL,CAArB;AACD;AACF,GAJD;;AAMA,MAAI6E,YAAY,SAAZA,SAAY,CAASJ,GAAT,EAAc;AAC5B,QAAIE,QAAQF,IAAIE,KAAhB;;AAEA;AACA,QAAGF,IAAIc,aAAP,EAAsB;AACpB,UAAG,CAACtD,MAAM0C,KAAN,CAAJ,EAAiB;AACf,eAAO,EAAP;AACD;;AAEDA,cAAQF,IAAIE,KAAJ,GAAY1C,MAAM0C,KAAN,CAApB;AACD;;AAED,QAAG7D,oBAAoBA,iBAAiBkE,MAAjB,CAAwBL,KAAxB,CAAvB,EAAuD;AACrD,aAAO7D,iBAAiBoE,KAAjB,CAAuBP,KAAvB,EAA8BlC,MAA9B,CAAqCgC,IAAIG,IAAzC,CAAP;AACD,KAFD,MAEO;AACL,aAAOS,KAAK4B,KAAL,CAAWtG,SAASgH,SAAT,CAAmBlD,IAAIG,IAAvB,CAAX,CAAP;AACD;;AAED,WAAOH,GAAP;AACD,GAnBD;;AAqBA,MAAIoD,gBAAgB,SAAhBA,aAAgB,CAAS5D,IAAT,EAAe;AACjC,QAAGA,KAAKM,GAAL,IAAYN,KAAKM,GAAL,CAAS+C,SAAxB,EAAmC;AACjCpF,0BAAoB+B,KAAKM,GAAL,CAAS+C,SAAT,GAAqB,IAAzC,CADiC,CACgB;AACjDnF,yBAAmBD,oBAAoB,CAAvC,CAFiC,CAEgB;AAClD,KAHD,MAGO;AACLA,0BAAoB,CAApB;AACAC,yBAAmB,CAAnB;AACD;;AAEDqG,aAASvE,IAAT;;AAEA,QAAG,OAAOzB,iBAAP,KAA6B,UAAhC,EAA4C;AAC1CA,wBAAkByB,KAAKH,IAAvB;AACD;AACF,GAdD;;AAgBA;AACA,MAAI0E,WAAW,SAAXA,QAAW,CAASvE,IAAT,EAAe;AAC5B,QAAG,CAACA,IAAD,IAAS,CAACA,KAAKM,GAAlB,EAAuB;AACrB;AACD;AACDvC,WAAOiC,KAAKM,GAAL,CAASvC,IAAhB;;AAEA;AACA,QAAGA,IAAH,EAAS;AACPA,aAAOA,IAAP;AACAC,cAAQ,EAAR;;AAEA,WAAI,IAAI0C,KAAR,IAAiB3C,IAAjB,EAAuB;AACrBC,cAAMD,KAAK2C,KAAL,CAAN,IAAqBA,KAArB;AACD;AACF;;AAED/D,WAAOe,IAAP,GAAcA,IAAd;AACD,GAjBD;AAiBE,CAxjBJ","file":"nano.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\common\\script\\basic","sourcesContent":["(function() {\n    function Emitter(obj) {\n    if (obj) return mixin(obj);\n  }\n    /**\n   * Mixin the emitter properties.\n   *\n   * @param {Object} obj\n   * @return {Object}\n   * @api private\n   */\n\n  function mixin(obj) {\n    for (var key in Emitter.prototype) {\n      obj[key] = Emitter.prototype[key];\n    }\n    return obj;\n  }\n\n  /**\n   * Listen on the given `event` with `fn`.\n   *\n   * @param {String} event\n   * @param {Function} fn\n   * @return {Emitter}\n   * @api public\n   */\n\n  Emitter.prototype.on =\n  Emitter.prototype.addEventListener = function(event, fn){\n    this._callbacks = this._callbacks || {};\n    (this._callbacks[event] = this._callbacks[event] || [])\n      .push(fn);\n    return this;\n  };\n\n  /**\n   * Adds an `event` listener that will be invoked a single\n   * time then automatically removed.\n   *\n   * @param {String} event\n   * @param {Function} fn\n   * @return {Emitter}\n   * @api public\n   */\n\n  Emitter.prototype.once = function(event, fn){\n    var self = this;\n    this._callbacks = this._callbacks || {};\n\n    function on() {\n      self.off(event, on);\n      fn.apply(this, arguments);\n    }\n\n    on.fn = fn;\n    this.on(event, on);\n    return this;\n  };\n\n  /**\n   * Remove the given callback for `event` or all\n   * registered callbacks.\n   *\n   * @param {String} event\n   * @param {Function} fn\n   * @return {Emitter}\n   * @api public\n   */\n\n  Emitter.prototype.off =\n  Emitter.prototype.removeListener =\n  Emitter.prototype.removeAllListeners =\n  Emitter.prototype.removeEventListener = function(event, fn){\n    this._callbacks = this._callbacks || {};\n\n    // all\n    if (0 == arguments.length) {\n      this._callbacks = {};\n      return this;\n    }\n\n    // specific event\n    var callbacks = this._callbacks[event];\n    if (!callbacks) return this;\n\n    // remove all handlers\n    if (1 == arguments.length) {\n      delete this._callbacks[event];\n      return this;\n    }\n\n    // remove specific handler\n    var cb;\n    for (var i = 0; i < callbacks.length; i++) {\n      cb = callbacks[i];\n      if (cb === fn || cb.fn === fn) {\n        callbacks.splice(i, 1);\n        break;\n      }\n    }\n    return this;\n  };\n\n  /**\n   * Emit `event` with the given args.\n   *\n   * @param {String} event\n   * @param {Mixed} ...\n   * @return {Emitter}\n   */\n\n  Emitter.prototype.emit = function(event){\n    this._callbacks = this._callbacks || {};\n    var args = [].slice.call(arguments, 1)\n      , callbacks = this._callbacks[event];\n\n    if (callbacks) {\n      callbacks = callbacks.slice(0);\n      for (var i = 0, len = callbacks.length; i < len; ++i) {\n        callbacks[i].apply(this, args);\n      }\n    }\n\n    return this;\n  };\n\n  /**\n   * Return array of callbacks for `event`.\n   *\n   * @param {String} event\n   * @return {Array}\n   * @api public\n   */\n\n  Emitter.prototype.listeners = function(event){\n    this._callbacks = this._callbacks || {};\n    return this._callbacks[event] || [];\n  };\n\n  /**\n   * Check if this emitter has `event` handlers.\n   *\n   * @param {String} event\n   * @return {Boolean}\n   * @api public\n   */\n\n  Emitter.prototype.hasListeners = function(event){\n    return !! this.listeners(event).length;\n  };\n  var JS_WS_CLIENT_TYPE = 'js-websocket';\n  var JS_WS_CLIENT_VERSION = '0.0.1';\n\n  var Protocol = window.Protocol;\n  var decodeIO_encoder = null;\n  var decodeIO_decoder = null;\n  var Package = Protocol.Package;\n  var Message = Protocol.Message;\n  var EventEmitter = Emitter;\n  var rsa = window.rsa;\n\n  var RES_OK = 200;\n  var RES_FAIL = 500;\n  var RES_OLD_CLIENT = 501;\n\n  if (typeof Object.create !== 'function') {\n    Object.create = function (o) {\n      function F() {}\n      F.prototype = o;\n      return new F();\n    };\n  }\n\n  var root = window;\n  var nano = Object.create(EventEmitter.prototype); // object extend from object\n  root.nano = nano;\n  var socket = null;\n  var reqId = 0;\n  var callbacks = {};\n  var handlers = {};\n  //Map from request id to route\n  var routeMap = {};\n  var dict = {};    // route string to code\n  var abbrs = {};   // code to route string\n\n  var heartbeatInterval = 0;\n  var heartbeatTimeout = 0;\n  var nextHeartbeatTimeout = 0;\n  var gapThreshold = 100;   // heartbeat gap threashold\n  var heartbeatId = null;\n  var heartbeatTimeoutId = null;\n  var handshakeCallback = null;\n\n  var decode = null;\n  var encode = null;\n\n  var reconnect = false;\n  var reconncetTimer = null;\n  var reconnectUrl = null;\n  var reconnectAttempts = 0;\n  var reconnectionDelay = 5000;\n  var DEFAULT_MAX_RECONNECT_ATTEMPTS = 10;\n\n  var useCrypto;\n\n  var handshakeBuffer = {\n    'sys': {\n      type: JS_WS_CLIENT_TYPE,\n      version: JS_WS_CLIENT_VERSION,\n      rsa: {}\n    },\n    'user': {\n    }\n  };\n\n  var initCallback = null;\n\n  nano.init = function(params, cb) {\n    initCallback = cb;\n    var host = params.host;\n    var port = params.port;\n    var path = params.path;\n\n    encode = params.encode || defaultEncode;\n    decode = params.decode || defaultDecode;\n\n    var url = 'ws://' + host;\n    if(port) {\n      url +=  ':' + port;\n    }\n\n    if(path) {\n      url += path;\n    }\n\n    handshakeBuffer.user = params.user;\n    if(params.encrypt) {\n      useCrypto = true;\n      rsa.generate(1024, \"10001\");\n      var data = {\n        rsa_n: rsa.n.toString(16),\n        rsa_e: rsa.e\n      };\n      handshakeBuffer.sys.rsa = data;\n    }\n    handshakeCallback = params.handshakeCallback;\n    connect(params, url, cb);\n  };\n\n  var defaultDecode = nano.decode = function(data) {\n    var msg = Message.decode(data);\n\n    if(msg.id > 0){\n      msg.route = routeMap[msg.id];\n      delete routeMap[msg.id];\n      if(!msg.route){\n        return;\n      }\n    }\n\n    msg.body = deCompose(msg);\n    return msg;\n  };\n\n  var defaultEncode = nano.encode = function(reqId, route, msg) {\n    var type = reqId ? Message.TYPE_REQUEST : Message.TYPE_NOTIFY;\n\n    if(decodeIO_encoder && decodeIO_encoder.lookup(route)) {\n      var Builder = decodeIO_encoder.build(route);\n      msg = new Builder(msg).encodeNB();\n    } else {\n      msg = Protocol.strencode(JSON.stringify(msg));\n    }\n\n    var compressRoute = 0;\n    if(dict && dict[route]) {\n      route = dict[route];\n      compressRoute = 1;\n    }\n\n    return Message.encode(reqId, type, compressRoute, route, msg);\n  };\n\n  var connect = function(params, url, cb) {\n    console.log('connect to ' + url);\n\n    var params = params || {};\n    var maxReconnectAttempts = params.maxReconnectAttempts || DEFAULT_MAX_RECONNECT_ATTEMPTS;\n    reconnectUrl = url;\n\n    var onopen = function(event) {\n      if(!!reconnect) {\n        nano.emit('reconnect');\n      }\n      reset();\n      var obj = Package.encode(Package.TYPE_HANDSHAKE, Protocol.strencode(JSON.stringify(handshakeBuffer)));\n      send(obj);\n    };\n    var onmessage = function(event) {\n      processPackage(Package.decode(event.data), cb);\n      // new package arrived, update the heartbeat timeout\n      if(heartbeatTimeout) {\n        nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\n      }\n    };\n    var onerror = function(event) {\n      nano.emit('io-error', event);\n      console.error('socket error: ', event);\n    };\n    var onclose = function(event) {\n      nano.emit('close',event);\n      nano.emit('disconnect', event);\n      console.log('socket close: ', event);\n      if(!!params.reconnect && reconnectAttempts < maxReconnectAttempts) {\n        reconnect = true;\n        reconnectAttempts++;\n        reconncetTimer = setTimeout(function() {\n          connect(params, reconnectUrl, cb);\n        }, reconnectionDelay);\n        reconnectionDelay *= 2;\n      }\n    };\n    socket = new WebSocket(url);\n    socket.binaryType = 'arraybuffer';\n    socket.onopen = onopen;\n    socket.onmessage = onmessage;\n    socket.onerror = onerror;\n    socket.onclose = onclose;\n  };\n\n  nano.disconnect = function() {\n    if(socket) {\n      if(socket.disconnect) socket.disconnect();\n      if(socket.close) socket.close();\n      console.log('disconnect');\n      socket = null;\n    }\n\n    if(heartbeatId) {\n      clearTimeout(heartbeatId);\n      heartbeatId = null;\n    }\n    if(heartbeatTimeoutId) {\n      clearTimeout(heartbeatTimeoutId);\n      heartbeatTimeoutId = null;\n    }\n  };\n\n  var reset = function() {\n    reconnect = false;\n    reconnectionDelay = 1000 * 5;\n    reconnectAttempts = 0;\n    clearTimeout(reconncetTimer);\n  };\n\n  nano.request = function(route, msg, cb) {\n    if(arguments.length === 2 && typeof msg === 'function') {\n      cb = msg;\n      msg = {};\n    } else {\n      msg = msg || {};\n    }\n    route = route || msg.route;\n    if(!route) {\n      return;\n    }\n\n    reqId++;\n    sendMessage(reqId, route, msg);\n\n    callbacks[reqId] = cb;\n    routeMap[reqId] = route;\n  };\n\n  nano.notify = function(route, msg) {\n    msg = msg || {};\n    sendMessage(0, route, msg);\n  };\n\n  var sendMessage = function(reqId, route, msg) {\n    if(useCrypto) {\n      msg = JSON.stringify(msg);\n      var sig = rsa.signString(msg, \"sha256\");\n      msg = JSON.parse(msg);\n      msg['__crypto__'] = sig;\n    }\n\n    if(encode) {\n      msg = encode(reqId, route, msg);\n    }\n\n    var packet = Package.encode(Package.TYPE_DATA, msg);\n    send(packet);\n  };\n\n  var send = function(packet) {\n    socket.send(packet.buffer);\n  };\n\n  var handler = {};\n\n  var heartbeat = function(data) {\n    if(!heartbeatInterval) {\n      // no heartbeat\n      return;\n    }\n\n    var obj = Package.encode(Package.TYPE_HEARTBEAT);\n    if(heartbeatTimeoutId) {\n      clearTimeout(heartbeatTimeoutId);\n      heartbeatTimeoutId = null;\n    }\n\n    if(heartbeatId) {\n      // already in a heartbeat interval\n      return;\n    }\n    heartbeatId = setTimeout(function() {\n      heartbeatId = null;\n      send(obj);\n\n      nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\n      heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, heartbeatTimeout);\n    }, heartbeatInterval);\n  };\n\n  var heartbeatTimeoutCb = function() {\n    var gap = nextHeartbeatTimeout - Date.now();\n    if(gap > gapThreshold) {\n      heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, gap);\n    } else {\n      console.error('server heartbeat timeout');\n      nano.emit('heartbeat timeout');\n      nano.disconnect();\n    }\n  };\n\n  var handshake = function(data) {\n    data = JSON.parse(Protocol.strdecode(data));\n    if(data.code === RES_OLD_CLIENT) {\n      nano.emit('error', 'client version not fullfill');\n      return;\n    }\n\n    if(data.code !== RES_OK) {\n      nano.emit('error', 'handshake fail');\n      return;\n    }\n\n    handshakeInit(data);\n\n    var obj = Package.encode(Package.TYPE_HANDSHAKE_ACK);\n    send(obj);\n    if(initCallback) {\n      initCallback(socket);\n    }\n  };\n\n  var onData = function(data) {\n    var msg = data;\n    if(decode) {\n      msg = decode(msg);\n    }\n    processMessage(nano, msg);\n  };\n\n  var onKick = function(data) {\n    data = JSON.parse(Protocol.strdecode(data));\n    nano.emit('onKick', data);\n  };\n\n  handlers[Package.TYPE_HANDSHAKE] = handshake;\n  handlers[Package.TYPE_HEARTBEAT] = heartbeat;\n  handlers[Package.TYPE_DATA] = onData;\n  handlers[Package.TYPE_KICK] = onKick;\n\n  var processPackage = function(msgs) {\n    if(Array.isArray(msgs)) {\n      for(var i=0; i<msgs.length; i++) {\n        var msg = msgs[i];\n        handlers[msg.type](msg.body);\n      }\n    } else {\n      handlers[msgs.type](msgs.body);\n    }\n  };\n\n  var processMessage = function(nano, msg) {\n    if(!msg.id) {\n      // server push message\n      nano.emit(msg.route, msg.body);\n      return;\n    }\n\n    //if have a id then find the callback function with the request\n    var cb = callbacks[msg.id];\n\n    delete callbacks[msg.id];\n    if(typeof cb !== 'function') {\n      return;\n    }\n\n    cb(msg.body);\n\n  };\n\n  var processMessageBatch = function(nano, msgs) {\n    for(var i=0, l=msgs.length; i<l; i++) {\n      processMessage(nano, msgs[i]);\n    }\n  };\n\n  var deCompose = function(msg) {\n    var route = msg.route;\n\n    //Decompose route from dict\n    if(msg.compressRoute) {\n      if(!abbrs[route]){\n        return {};\n      }\n\n      route = msg.route = abbrs[route];\n    }\n\n    if(decodeIO_decoder && decodeIO_decoder.lookup(route)) {\n      return decodeIO_decoder.build(route).decode(msg.body);\n    } else {\n      return JSON.parse(Protocol.strdecode(msg.body));\n    }\n\n    return msg;\n  };\n\n  var handshakeInit = function(data) {\n    if(data.sys && data.sys.heartbeat) {\n      heartbeatInterval = data.sys.heartbeat * 1000;   // heartbeat interval\n      heartbeatTimeout = heartbeatInterval * 2;        // max heartbeat timeout\n    } else {\n      heartbeatInterval = 0;\n      heartbeatTimeout = 0;\n    }\n\n    initData(data);\n\n    if(typeof handshakeCallback === 'function') {\n      handshakeCallback(data.user);\n    }\n  };\n\n  //Initilize data used in nano client\n  var initData = function(data) {\n    if(!data || !data.sys) {\n      return;\n    }\n    dict = data.sys.dict;\n\n    //Init compress dict\n    if(dict) {\n      dict = dict;\n      abbrs = {};\n\n      for(var route in dict) {\n        abbrs[dict[route]] = route;\n      }\n    }\n\n    window.nano = nano;\n  }})();\n"]}